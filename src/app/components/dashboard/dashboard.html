<div class="max-w-[600px] mx-auto p-4 pb-24">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-text-main">Accounts</h1>
    @if (codes().length > 0) {
      <button
        (click)="toggleSelectionMode()"
        class="text-sm font-medium px-3 py-1.5 rounded-md transition-all border-none bg-surface-variant text-text-secondary hover:bg-bg-secondary hover:text-primary cursor-pointer"
      >
        {{ isSelectionMode() ? 'Done' : 'Select' }}
      </button>
    }
  </div>

  @if (codes().length === 0) {
    <div
      class="flex flex-col items-center justify-center text-center py-16 px-4 text-text-secondary"
    >
      <div class="text-primary mb-6 opacity-80">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="64"
          height="64"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
        </svg>
      </div>
      <h2 class="text-text-main mb-2">No Accounts yet</h2>
      <p class="mb-8 max-w-[300px]">
        Secure your online presence by adding your first 2FA account.
      </p>
      <a
        routerLink="/add"
        class="inline-flex items-center justify-center px-4 py-2 rounded-md font-medium cursor-pointer transition-all bg-primary text-white hover:bg-primary-hover border-none no-underline"
        >Add Account</a
      >
    </div>
  } @else {
    <div class="flex flex-col gap-8" cdkDropListGroup>
      @for (group of groupedCodes(); track group.name) {
        <div>
          @if (group.name) {
            <h3
              class="text-text-secondary text-sm font-semibold uppercase tracking-wider mb-4 px-1 flex items-center gap-2"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"
                ></path>
              </svg>
              {{ group.name }}
            </h3>
          }
          <div
            class="grid grid-cols-1 gap-4 min-h-[50px]"
            cdkDropList
            [id]="group.name"
            [cdkDropListData]="group.items"
            (cdkDropListDropped)="onDrop($event)"
          >
            @for (item of group.items; track item.account.id) {
              <div
                class="bg-surface border border-border rounded-lg p-5 relative transition-all cursor-pointer overflow-hidden hover:-translate-y-0.5 hover:shadow-md hover:border-primary active:scale-[0.98]"
                [class.ring-2]="selectedIds().has(item.account.id)"
                [class.ring-primary]="selectedIds().has(item.account.id)"
                [class.border-primary]="selectedIds().has(item.account.id)"
                (click)="isSelectionMode() ? toggleSelect(item.account.id) : copyCode(item.code)"
                (keydown.enter)="
                  isSelectionMode() ? toggleSelect(item.account.id) : copyCode(item.code)
                "
                tabindex="0"
                [title]="isSelectionMode() ? 'Select' : 'Click to copy'"
                role="button"
                cdkDrag
                [cdkDragDisabled]="isSelectionMode()"
                [cdkDragData]="item"
              >
                <!-- Drag Preview Placeholder -->
                <div
                  *cdkDragPlaceholder
                  class="bg-bg-secondary border-2 border-dashed border-primary rounded-lg h-[140px] mb-4"
                ></div>

                <div class="flex justify-between items-start mb-4">
                  <div class="flex items-center gap-3">
                    @if (isSelectionMode()) {
                      <div
                        class="w-5 h-5 rounded border flex items-center justify-center transition-all"
                        [class.bg-primary]="selectedIds().has(item.account.id)"
                        [class.border-primary]="selectedIds().has(item.account.id)"
                        [class.border-border]="!selectedIds().has(item.account.id)"
                      >
                        @if (selectedIds().has(item.account.id)) {
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="14"
                            height="14"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="white"
                            stroke-width="3"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <polyline points="20 6 9 17 4 12" />
                          </svg>
                        }
                      </div>
                    }
                    <div class="flex flex-col">
                      <span class="font-semibold text-base text-text-main leading-tight">{{
                        item.account.issuer || 'Unknown'
                      }}</span>
                      <span class="text-[0.85rem] text-text-secondary mt-0.5">{{
                        item.account.label
                      }}</span>
                    </div>
                  </div>
                  <div class="flex items-center gap-1">
                    @if (!isSelectionMode()) {
                      <button
                        class="p-1 opacity-50 hover:opacity-100 hover:text-primary flex items-center justify-center rounded-md transition-all border-none bg-transparent cursor-pointer"
                        (click)="$event.stopPropagation(); editFolder(item.account)"
                        title="Edit Folder"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <path
                            d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"
                          ></path>
                          <line x1="12" y1="11" x2="12" y2="17"></line>
                          <line x1="9" y1="14" x2="15" y2="14"></line>
                        </svg>
                      </button>
                      <button
                        class="p-1 opacity-50 hover:opacity-100 hover:text-danger flex items-center justify-center rounded-md transition-all border-none bg-transparent cursor-pointer"
                        (click)="$event.stopPropagation(); delete(item.account.id)"
                        title="Delete"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <polyline points="3 6 5 6 21 6" />
                          <path
                            d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                          />
                        </svg>
                      </button>
                    }
                  </div>
                </div>

                <div
                  class="font-mono text-[2.5rem] font-medium text-primary tracking-[0.2rem] text-center my-2 mb-6"
                >
                  {{ item.code }}
                </div>

                <div class="absolute bottom-0 left-0 right-0 h-1 bg-bg">
                  <div
                    class="h-full bg-primary transition-[width] duration-1000 ease-linear"
                    [style.width.%]="item.progress * 100"
                    [class.bg-danger]="item.progress < 0.2"
                  ></div>
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }

  @if (isSelectionMode()) {
    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 z-100 flex gap-4">
      <button
        (click)="deleteSelected()"
        [disabled]="selectedIds().size === 0"
        class="flex items-center gap-2 px-6 py-3 rounded-full bg-danger text-white shadow-lg transition-all hover:bg-danger-hover hover:scale-105 disabled:opacity-50 disabled:scale-100 disabled:cursor-not-allowed border-none font-semibold cursor-pointer"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <polyline points="3 6 5 6 21 6" />
          <path
            d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
          />
          <line x1="10" y1="11" x2="10" y2="17" />
          <line x1="14" y1="11" x2="14" y2="17" />
        </svg>
        Delete Selected ({{ selectedIds().size }})
      </button>
    </div>
  } @else {
    <a
      routerLink="/add"
      class="fixed bottom-6 right-6 w-[56px] h-[56px] rounded-full bg-primary text-white flex items-center justify-center shadow-md transition-all z-100 hover:bg-primary-hover hover:scale-105"
      title="Add Account"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <line x1="12" y1="5" x2="12" y2="19" />
        <line x1="5" y1="12" x2="19" y2="12" />
      </svg>
    </a>
  }
</div>
